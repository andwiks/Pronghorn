<?php

/**
 * Implements hook_services_resources().
 */
function apps_services_v2_transaction_data_services_resources() {
    return array(
        'transaction_v2' => array(
            'actions' => array(
                'favorite' => array(
                    'help' => 'Add/Remove Favorite Order',
                    'callback' => 'apps_services_v2_transaction_data_favorite',
                    'file' => array(
                        'type' => 'inc',
                        'module' => 'apps_services_v2_transaction_data',
                        'name' => 'apps_services_v2_transaction_data',
                    ),
                    'documentation callback' => 'apps_services_v2_transaction_data_favorite_doc',
                    'access callback' => 'services_access_menu',
                    'args' => array(
                      array(
                        'name' => 'order_id',
                        'type' => 'int',
                        'description' => 'favorite order id',
                        'source' => array(
                          'data' => 'order_id',
                          'param' => 'order_id',
                        ),
                        'optional' => FALSE,
                        'http_method' => 'POST',
                      ),
                      array(
                        'name' => 'source',
                        'type' => 'string',
                        'description' => 'the source of the request',
                        'source' => array(
                          'data' => 'source',
                          'param' => 'source',
                        ),
                        'optional' => FALSE,
                        'http_method' => 'POST',
                      ),
                    ),
                ),
                'home_transaction_list' => array(
                    'help' => 'Get Transaction List in Home Page',
                    'callback' => 'apps_services_v2_transaction_home_list',
                    'file' => array(
                        'type' => 'inc',
                        'module' => 'apps_services_v2_transaction_data',
                        'name' => 'apps_services_v2_transaction_data',
                    ),
                    'documentation callback' => 'apps_services_v2_transaction_home_list_doc',
                    'access callback' => 'services_access_menu',
                    'args' => array(
                      array(
                        'name' => 'size',
                        'type' => 'int',
                        'description' => 'number of items shown',
                        'source' => array(
                          'data' => 'size',
                          'param' => 'size',
                        ),
                        'default value' => 5,
                        'optional' => TRUE,
                        'http_method' => 'POST',
                      ),
                      array(
                        'name' => 'favorite_only',
                        'type' => 'int',
                        'description' => 'show favorite only order list if set true',
                        'source' => array(
                          'data' => 'favorite_only',
                          'param' => 'favorite_only',
                        ),
                        'default value' => 0,
                        'optional' => TRUE,
                        'http_method' => 'POST',
                      ),
                      array(
                        'name' => 'source',
                        'type' => 'string',
                        'description' => 'the source of the request',
                        'source' => array(
                          'data' => 'source',
                          'param' => 'source',
                        ),
                        'optional' => FALSE,
                        'http_method' => 'POST',
                      ),
                    ),
                ),
            ),
        ),
    );
}

/**
 * Function apps_services_v2_transaction_data_favorite_doc().
 *
 * Documentation callback for favorite transaction.
 */
function apps_services_v2_transaction_data_favorite_doc() {
  global $base_url;
  $response = '
    {
      "order_id" : "12345",
      "source" : "android"
    }
  ';
  $element = array(
    '#name' => 'Transaction Favorite Apps Service',
    '#description' => 'Add/Remove Favorite transaction.',
    '#auth' => FALSE,
    '#path' => 'transaction_v2/favorite',
    // Example request. E.g., a request URL, headers, and a JSON array.
    '#request_url' => $base_url . '/air/transaction_v2/favorite.json<br />'
    . 'POST data application/json: { "order_id" : "12345", "source" : "android" }',
    // Example response. E.g., a JSON array.
    '#response' => $response,
    // Resource prefix.
    // Errors.
    '#errors' => array(
	  'missing_argument' => array(
        '#question' => '401 Unauthorized : Missing required argument',
        '#description' => 'When drupal detect that the user missed some of the input required.',
        '#response' => '
        [
          "Missing required argument"
        ]',
      ),
      'internal_server' => array(
        '#question' => '500 Internal Server Error',
        '#description' => 'Drupal server can not handle the request. Drupal will output nothing.',
        '#response' => '',
      ),
    ),
  );
  return $element;
}

/**
 * Function apps_services_v2_transaction_home_list_doc().
 *
 * Documentation callback for transaction home list.
 */
function apps_services_v2_transaction_home_list_doc() {
  global $base_url;
  $response = '
    {
      "size": "10",
      "source" : "android"
    }
  ';
  $element = array(
    '#name' => 'Transaction Home Page List',
    '#description' => 'Get the list of home page transaction.',
    '#auth' => FALSE,
    '#path' => 'transaction_v2/home_transaction_list',
    // Example request. E.g., a request URL, headers, and a JSON array.
    '#request_url' => $base_url . '/air/transaction_v2/home_transaction_list.json',
    // Example response. E.g., a JSON array.
    '#response' => $response,
    // Resource prefix.
    // Errors.
    '#errors' => array(
	    'internal_server' => array(
        '#question' => '500 Internal Server Error',
        '#description' => 'Drupal server can not handle the request. Drupal will output nothing.',
        '#response' => '',
      ),
    ),
  );
  return $element;
}

/**
 * Implements hook_views_api()
 * set init data before views data
 */
function apps_services_v2_transaction_data_views_api() {
  return array(
    'api' => 2,
    'path' => drupal_get_path('module','apps_services_v2_transaction_data'). '/views',
  );
}

/**
 * Implements hook_views_data().
 * put favorite data into views
 */
function apps_services_v2_transaction_data_views_data() {
	$data['favorite_transaction']['table']['group'] = 'Favorite Order';

  $data['favorite_transaction']['table']['base'] = array(
		'field' => 'order_id',
		'title' => 'Order ID',
  );

  $data['favorite_transaction']['table']['join'] = array(
		'commerce_order' => array(
				'left_field' => 'order_id',
				'field' => 'order_id',
		),
		'users' => array(
				'left_field' => 'uid',
				'field' => 'uid',
		),
  );
	
	 $data ['favorite_transaction']['order_id'] = array(
    'title' => t('Order ID'),
    'help' => t('Order ID'),
    // Define a relationship to the {node} table, so example_table views can
    // add a relationship to nodes. If you want to define a relationship the
    // other direction, use hook_views_data_alter(), or use the 'implicit' join
    // method described above.
    'relationship' => array(
      'base' => 'commerce_order', // The name of the table to join with.
      'base field' => 'order_id', // The name of the field on the joined table.
      // 'field' => 'nid' -- see hook_views_data_alter(); not needed here.
      'handler' => 'views_handler_relationship',
      'label' => t('Commerce Order Relationship'),
      'title' => t('Commerce Order Relationship'),
      'help' => t('Relationship to commerce order table'),
    ),
  );
	 
	 $data ['favorite_transaction']['uid'] = array(
    'title' => t('UID'),
    'help' => t('User UID who favorited the order'),
    'relationship' => array(
      'base' => 'users', // The name of the table to join with.
      'base field' => 'uid', // The name of the field on the joined table.
      'handler' => 'views_handler_relationship',
      'label' => t('Users Relationship'),
      'title' => t('Users Relationship'),
      'help' => t('Relationship to users table'),
    ),
  );
   
  // Describe the order id column of the favorite transaction.
  $data['favorite_transaction']['order_id'] = array(
      'title' => t('Order Id'),
      'help' => t('Favorite transaction order id'),
      'field' => array(
          'handler' => 'views_handler_field_numeric',
					'click sortable' => TRUE,
      ),
      'argument' => array(
          'handler' => 'views_handler_argument_numeric',
          'name field' => 'order_id', // display this field in the summary
      ),
      'sort' => array(
          'handler' => 'views_handler_sort_numeric',
      ),
      'filter' => array(
          'handler' => 'views_handler_filter_numeric',
      ),
  );
  
  // Describe the uid column of the favorite transaction.
  $data['favorite_transaction']['uid'] = array(
      'title' => t('User Id'),
      'help' => t('Favorite transaction user id'),
      'field' => array(
          'handler' => 'views_handler_field_numeric',
					'click sortable' => TRUE,
      ),
      'argument' => array(
          'handler' => 'views_handler_argument_numeric',
          'name field' => 'uid', // display this field in the summary
      ),
      'sort' => array(
          'handler' => 'views_handler_sort_numeric',
      ),
      'filter' => array(
          'handler' => 'views_handler_filter_numeric',
      ),
  );

  // Describe the created column of the favorite transaction.
  $data['favorite_transaction']['created'] = array(
      'title' => t('Created Date'),
      'help' => t('Favorite transaction created date'),
      'field' => array(
          'handler' => 'views_handler_field_numeric',
					'click sortable' => TRUE,
      ),
      'argument' => array(
          'handler' => 'views_handler_argument_numeric',
          'name field' => 'created', // display this field in the summary
      ),
      'sort' => array(
          'handler' => 'views_handler_sort_numeric',
      ),
      'filter' => array(
          'handler' => 'views_handler_filter_numeric',
      ),
  );
	
  return $data;
}