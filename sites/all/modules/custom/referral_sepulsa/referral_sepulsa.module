<?php

function referral_sepulsa_menu() {
	$items = array();

	$items['admin/config/people/referral/custom_text'] = array(
		'title'            => t('Referral Custom Text'),
		'description'      => t('Referral Custom Page'),
		'page callback'    => 'drupal_get_form',
		'page arguments'   => array('referral_custom_text'),
		'access arguments' => array('administer site configuration'),
		'type'             => MENU_NORMAL_ITEM,
	);
		
	$items['admin/config/people/referral/referral_list'] = array(
		'title'            => t('Referral List'),
		'page callback'    => 'admin_referral_list',
		'access arguments' => array('administer site configuration'),
		'type'             => MENU_NORMAL_ITEM,
	);
	
	$items['admin/config/people/referral/transaction_list'] = array(
		'title'            => t('Referral Transaction List'),
		'page callback'    => 'referral_transaction_list',
		'access arguments' => array('administer site configuration'),
		'type'             => MENU_NORMAL_ITEM,
	);
	
	$items['user/referral_list'] = array(
		'title' => t('Your Referral'),
		'page callback' => 'referral_list',
		'access arguments' => array(REFERRAL_PERM_USE),
		'type' =>  MENU_CALLBACK,
	);
    
  return $items;
}

function referral_custom_text() {
	$form['referral_custom_text'] = array(
		'#type' => 'textarea',
		'#title' => t('Referral Custom Text'),
		'#default_value' => variable_get('referral_custom_text', ''),
		'#description' => t('Referral Custom text in User Page'),
	);

	return system_settings_form($form);
}

// Override Hook User View from Userpoints Module
function referral_sepulsa_user_view_alter(&$build) {
    //drupal_set_message("<pre>".print_r($build, true)."</pre>");
		unset($build['Referrals']);
    /*global $user, $base_url;  
    $logo = theme_get_setting('logo');
    $inline_script = '<meta property="og:image" content="'.$logo.'" />';
    $element = array(
      '#type' => 'markup',
      '#markup' => $inline_script,
    );
    drupal_add_html_head($element, 'facebook_metatag');
    
    $path_to_theme = $base_url.'/'.drupal_get_path('theme', 'sepulsa');
    $referral_link = url('referral/'. _referral_uid2ref($user->uid), array('query' => NULL, 'fragment' => NULL, 'absolute' => TRUE));
    $output = "<p><input id='referral_text' class='referral_text' size='50' readonly='true' type='text' value='".$referral_link."'></p>";
    $output .= '
        <script type="text/javascript" src="'.$path_to_theme.'/js/zclip/jquery.zclip.js"></script>
        <script type="text/javascript">
				(function($){
					$(document).ready(function() {
							$("#copy-link-wrap").zclip({
									path: "'.$path_to_theme.'/js/zclip/ZeroClipboard.swf",
									copy: $("#toclip").val(),
									afterCopy: function() {
											alert("Your Referral link has been copied");
									}
							});
					});
				})(jQuery)
        </script>
        <style>
        .referral_text { background-color: #eee; border: 1px solid #ccc; height: 40px; line-height: 40px; padding: 0 15px; box-shadow: inset 0px 0px 10px rgba(0,0,0,0.1); margin: 10px 0; }
        .share_referral { margin-bottom: 20px; }
        .share_referral span { float: left; margin-right: 5px; font-weight: 700; text-transform: uppercase; margin-top: 10px; }
        .share_referral a { float: left; border: 1px solid #ccc; background: #f9f9f9; padding: 8px 20px; border-radius: 8px; margin-left: 10px; font-size: 14px;}
        
        </style>
        <div class="share_referral clearfix"><span>Share in:</span>
            <a href="http://www.facebook.com/sharer.php?u='.$referral_link.'" target="_blank"><i class="fa fa-facebook"></i> Facebook</a> 
            <a href="http://twitter.com/share?url='.$referral_link.'&text=TEXT&hashtags=sepulsa" target="_blank""><i class="fa fa-twitter"></i> Twitter</a> 
            <a href="#" id="copy-link-wrap">
            <i class="fa fa-envelope"></i> Copy
            <input name="toclip" id="toclip" type="hidden" value="'.$referral_link.'">
            </a>
        </div>';
    
    $output .= variable_get('referral_custom_text');
    $build['Referrals'][0]['#markup'] = $output;*/
}

function referral_sepulsa_form_alter(&$form, $form_state, $form_id) {
  if ($form_id == 'user_register_form') {
    if (isset($_COOKIE[REFERRAL_COOKIE])) {
			$arg0 = arg(0);
			$arg1 = arg(1);
			if ($arg0 == 'user' && $arg1 == 'register') {
				$cookie = unserialize($_COOKIE[REFERRAL_COOKIE]);
				$user = user_load($cookie['uid']);
				$title = 'Anda diundang bergabung oleh '.$user->mail;
				drupal_set_title($title);
			}
    }
  }
}

/**
 * Implements hook_theme().
 */
function referral_sepulsa_theme($existing, $type, $theme, $path) {
    return array(
      'referral_list' => array(
        'variables' => array('content' => NULL),
        'template' => 'referral_list',
        'path' => drupal_get_path('module', 'referral_sepulsa')
      ),
			'admin_referral_list' => array(
        'variables' => array('content' => NULL),
        'template' => 'admin_referral_list',
        'path' => drupal_get_path('module', 'referral_sepulsa')
      ),
			'referral_transaction_list' => array(
        'variables' => array('content' => NULL),
        'template' => 'referral_transaction_list',
        'path' => drupal_get_path('module', 'referral_sepulsa')
      )
    );
}


/*
// Override Point Tab from Userpoints Module
function referral_sepulsa_menu_alter(&$items) {
	
    unset($items['user/%user/points']);
    $items['user/%user/referral/view'] = array(
			'page callback'    => 'referral_list',
			'title'            => t('Your Referrals'),
			'access arguments' => array(REFERRAL_PERM_USE),
			'type' => MENU_LOCAL_TASK,
		);
}
*/

function referral_list(){
	global $user;
	$content = array();
	$referral_list = _get_referral_list($user->uid);
	$content = $referral_list;
	
  return theme('referral_list', array('content' => $content));
}

function _get_referral_list($uid) {
	$referral_list = array();
	$order_id = '';
	$date_txn = '';
	
	// get referral list - start
	$referred_by = db_query("SELECT u.mail, u.created FROM referral r INNER JOIN users u ON r.referral_uid = u.uid WHERE r.uid = :uid", array('uid' => $uid))->fetchField();
	$referral = db_query("SELECT r.uid, u.mail, u.created FROM referral r INNER JOIN users u ON r.uid = u.uid WHERE r.referral_uid = :uid", array('uid' => $uid));
	foreach ($referral as $data) {
		// get the points
		$points = '';
		$userpoint = db_query_range("SELECT points FROM userpoints_txn WHERE uid = :uid AND status = 0 ORDER BY txn_id ASC", 0, 1, array('uid' => $data->uid));
		foreach ($userpoint as $row) {
			$points = number_format($row->points,0,",",".");
		}
		
		// get first order
		$order = db_query_range("SELECT order_id, created FROM {commerce_order} WHERE (status = 'invoiced' OR status = 'completed' OR status = 'processing') AND uid = :uid ORDER by created ASC", 0, 1, array('uid' => $data->uid));
    foreach ($order as $row) {
			$order_id = $row->order_id;
			$date_txn = $row->created;
			$date_txn = format_date($date_txn, 'custom', REFERRAL_DATE_FORMAT);
		}
		
		//if (isset($order_id)) {
			$referral_list[] = array(
				'uid' => $data->uid,
				'email' => $data->mail,
				'date_registered' => format_date($data->created, 'custom', REFERRAL_DATE_FORMAT),
				'points' => $points,
				'order_id' => $order_id,
				'date_txn' => $date_txn,
			);
		//}
	}
	// get referral list - end
	$referral = array(
		'referred_by' => $referred_by,
		'referral_list' => $referral_list
	);
	return $referral;
}

function admin_referral_list() {
	//$form = drupal_get_form('admin_referral_list_form');
	//$output = drupal_render($form);
	$content = array();
	if (isset($_SESSION['referral_list'])) {
		$content = $_SESSION['referral_list'];
	}
	
  return theme('admin_referral_list', array('content' => $content));
}

function admin_referral_list_form() {
	$email = '';
	if (isset($_SESSION['email'])) $email = $_SESSION['email'];
	
	$form['referral_email'] = array(
		'#type' => 'textfield',
		'#title' => t('Email'),
		'#required' => true,
		'#default_value' => $email
	);
	$form['submit'] = array(
		'#type' => 'submit', 
		'#title' => 'Submit',
		'#value' => 'Submit'
	);

	return $form;
}

function admin_referral_list_form_submit($form, &$form_state){
	//drupal_set_message('<pre>'.print_r($form, true).'</pre>');
	$email = $form['referral_email']['#value'];
	$uid = db_query("SELECT uid FROM users WHERE mail='".$email."'")->fetchField();
	if (empty($uid)) {
		drupal_set_message('Email not found');
	} else {
		$referral_list = _get_referral_list($uid);
		$_SESSION['referral_list'] = $referral_list;
		$_SESSION['email'] = $email;
	}
}

function referral_transaction_list() {
	$content = array();
	$query = "SELECT order_id, a.created, a.mail, a.uid FROM commerce_order a
						INNER JOIN userpoints_txn b ON a.uid = b.uid
						INNER JOIN referral c ON b.uid = c.uid
						WHERE b.points > 0 AND a.status IN('invoiced', 'completed', 'processing')
						GROUP BY a.uid
						ORDER BY order_id DESC";
	$order = db_query_range($query, 0, 50);
	foreach ($order as $row) {
		$order_id = $row->order_id;
		$date_txn = $row->created;
		$mail = $row->mail;
		$uid = $row->uid;
		// get order total
		$order = commerce_order_load($order_id);
		$wrapper = entity_metadata_wrapper('commerce_order', $order);
		$total = $wrapper->commerce_order_total->amount->value();
		$total = number_format($total,0,",",".");
		// get referrer email
		$query = 'SELECT mail FROM users a INNER JOIN referral b ON a.uid = b.referral_uid WHERE b.uid = '.$uid;
		$referrer_mail = db_query_range($query, 0, 1)->fetchField();
		$content[] = array(
			'mail' => $mail,
			'order_id' => $order_id,
			'order_date' => format_date($date_txn, 'custom', REFERRAL_DATE_FORMAT),
			'order_total' => $total,
			'referrer_mail' => $referrer_mail
		);
	}
	//drupal_set_message('<pre>'.print_r($content, true).'</pre>');
  return theme('referral_transaction_list', array('content' => $content));
}

function referral_sepulsa_mail($key, &$message, $params) {
  switch ($key) {
    case 'referral_credit_notification':
      $message['subject'] = $params['subject'];
      $message['body'] = array(0=>$params['body']);
    break;
    }
}