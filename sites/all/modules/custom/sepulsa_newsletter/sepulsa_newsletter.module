<?php
/**
 * @file
 * sepulsa_newsletter.module
 *
 * @author aizat@sepulsa.com
 */

/**
 * Impelements hook_menu().
 */
function sepulsa_newsletter_menu() {

  // Administration pages.
  $items['admin/config/people/mailchimp-config'] = array(
    'title' => 'Mailchimp Configuration',
    'description' => 'Mailchimp Configuration.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('sepulsa_newsletter_form'),
    'access arguments' => array('access administration pages'),
  );

  $items['test/print'] = array(
      'page callback' => 'sepulsa_newsletter_printquery',
      'access callback' => TRUE
    );

  return $items;
}

function sepulsa_newsletter_printquery(){
  echo "<pre>";
  $settings = array(
  		'method' => 'POST',
  		'op' => 'members',
  		'email' => 'test@sepulsa.com',
  		'status' => 'subscribed',
  	);
  sepulsa_newsletter_mailchimp_api($settings);
  print_r($result);
}

/**
 * Function sepulsa_newsletter_form().
 */
function sepulsa_newsletter_form($form, &$form_state) {

  $form['sepulsa_newsletter_api_url'] = array(
    '#type' => 'textfield',
    '#title' => 'Mailchimp API URL ?',
    '#size' => 200,
    '#maxlength' => 200,
    '#default_value' => variable_get('sepulsa_newsletter_api_url', 'https://us12.api.mailchimp.com/3.0/lists'),
    '#required' => TRUE,
  );

  $form['sepulsa_newsletter_id_member'] = array(
    '#type' => 'textfield',
    '#title' => 'Mailchimp ID Member ?',
    '#size' => 200,
    '#maxlength' => 200,
    '#default_value' => variable_get('sepulsa_newsletter_id_member', 'a38de08c0b'),
    '#required' => TRUE,
  );

  return system_settings_form($form);
}

/**
 * Function sepulsa_newsletter_mailchimp_api().
 *
 * @param
 * $settings -> array (method, op, email, status)
 */
function sepulsa_newsletter_mailchimp_api($settings){
  // Untuk Edit subscribed / unsubscribed.
  // URL API, us12 adalah key terakhir sebelum - di API KEY.
  $url = variable_get('sepulsa_newsletter_api_url', 'https://us12.api.mailchimp.com/3.0/lists');

  // ID List Member test : a38de08c0b.
  // ID List Member prod : 2ae89eac82.
  $id = variable_get('sepulsa_newsletter_id_member', 'a38de08c0b');

  // Operation untuk mengambil list member.
  $op = $settings['op'];

  // MD5 Email yang akan di ganti. 
  $email = md5($settings['email']);

  $data = array(
  		'email_address' => $settings['email'],
  		'status' => $settings['status'],
  	);

  // Define option for http request.
  $http_options = array(
  	// Define Method.
    'method' => $settings['method'],
    'headers' => array(	
      'Content-Type' =>  'application/json',
      'Accept' => 'application/json',
      // Define username:apikey.
      'Authorization' => 'Basic ' . base64_encode("sepulsanews:0cf0d5df56cc65702c6c5a7d404ac244-us12"),
      ),
    // Define Data.
    'data' => json_encode($data),
    );
  if ($settings['method'] == 'POST') {
  	$result = drupal_http_request($url . '/' . $id . '/' . $op, $http_options);
  } 
  elseif ($settings['method'] == 'PUT') {
  	$result = drupal_http_request($url . '/' . $id . '/' . $op . '/' . $email, $http_options);
  }
  else {
  	unset($http_options['data']);
  	$result = drupal_http_request($url . '/' . $id . '/' . $op . '/' . $email, $http_options);
  }

  // print_r($result);
  return $result;
}

/* implement hook_user_presave() */
function sepulsa_newsletter_user_presave(&$edit, $account, $category) {
    // watchdog('status Newsletter', '<pre> edit : @edit, account : @account, category : @category, </pre>', 
    // 		array('@edit' => print_r($edit, true), '@account' => print_r($account, true), '@category' => print_r($category, true)));
  $result = 'HTTP request not sent';
  if ($edit['field_newsletter_subscribers']['und'][0]['value'] == 1) {
	$status = 'subscribed';
  }
  else {
	$status = 'unsubscribed';
  }
  if (isset($account->is_new) && !empty($account->is_new)) {
    $settings = array(
  	  'method' => 'POST',
  	  'op' => 'members',
  	  'email' => $edit['mail'],
  	  'status' => $status,
  	);
    $result = sepulsa_newsletter_mailchimp_api($settings);
    watchdog('Insert Newsletter', '<pre> result : @result, </pre>', array('@result' => print_r($result, true)));
  } else {
    $settings = array(
  	  'method' => 'PUT',
  	  'op' => 'members',
  	  'email' => $edit['mail'],
  	  'status' => $status,
  	);
    $result = sepulsa_newsletter_mailchimp_api($settings);
    watchdog('Update Newsletter', '<pre> result : @result, </pre>', array('@result' => print_r($result, true)));
  }
}